# Sistema de Pipes - Comunica√ß√£o entre Processos

## üìã Resumo do Sistema

Este documento descreve a implementa√ß√£o do sistema de comunica√ß√£o entre processos usando pipes an√¥nimos. O sistema permite a comunica√ß√£o bidirecional entre diferentes componentes do sistema de trading atrav√©s de uma arquitetura bem definida.

## üèóÔ∏è Arquitetura de Comunica√ß√£o

### Fluxo de Comunica√ß√£o:
```
Traders ‚Üí Executor ‚Üí Price Updater ‚Üí Arbitrage Monitor
    ‚Üë                                    ‚Üì
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Pipes Implementados:

1. **Traders ‚Üí Executor**: Envio de ordens de compra/venda
2. **Executor ‚Üí Price Updater**: Atualiza√ß√µes de pre√ßos ap√≥s execu√ß√£o
3. **Price Updater ‚Üí Arbitrage Monitor**: Detec√ß√£o de oportunidades de arbitragem
4. **Arbitrage Monitor ‚Üí Traders**: Feedback sobre oportunidades detectadas
5. **Controle**: Comunica√ß√£o de controle geral do sistema

## üéØ Funcionalidades Implementadas

### 1. **Cria√ß√£o de Pipes do Sistema**

#### `criar_pipes_sistema()` (TAREFA DO ALUNO)
- **Descri√ß√£o**: Cria todos os pipes necess√°rios para comunica√ß√£o entre processos
- **Retorno**: Array de descritores de arquivo (10 descritores para 5 pipes)
- **Funcionalidades**:
  - Cria 5 pipes an√¥nimos
  - Configura pipes como n√£o-bloqueantes
  - Retorna array de descritores
  - Tratamento de erros para falhas na cria√ß√£o

**Exemplo de uso:**
```c
int* descritores = criar_pipes_sistema();
if (!descritores) {
    printf("Erro: Falha ao criar pipes do sistema\n");
    return 1;
}
```

### 2. **Tratamento de Erros para Falhas na Cria√ß√£o de Pipes** (TAREFA DO ALUNO)

**Implementado em `criar_pipes_sistema()`:**
- Verifica√ß√£o de retorno de `pipe()`
- Limpeza autom√°tica em caso de falha
- Mensagens de erro detalhadas
- Rollback de pipes j√° criados

**Exemplo de tratamento:**
```c
if (pipe(sistema_pipes.traders_to_executor) == -1) {
    perror("ERRO: Falha ao criar pipe Traders -> Executor");
    return NULL;
}
```

### 3. **Gerenciamento de Descritores de Arquivo**

#### `limpar_pipes_sistema()`
- **Descri√ß√£o**: Fecha todos os descritores de arquivo dos pipes
- **Funcionalidades**:
  - Fecha descritores de leitura e escrita
  - Verifica se descritores s√£o v√°lidos antes de fechar
  - Log de fechamento de cada pipe
  - Reset do status do sistema

#### `pipes_estao_ativos()`
- **Descri√ß√£o**: Verifica se os pipes est√£o ativos
- **Retorno**: 1 se ativos, 0 caso contr√°rio

#### `imprimir_status_pipes()`
- **Descri√ß√£o**: Exibe status detalhado dos pipes
- **Informa√ß√µes exibidas**:
  - N√∫mero de pipes criados
  - Status de ativa√ß√£o
  - Descritores de cada pipe

### 4. **Comunica√ß√£o via Mensagens**

#### Estrutura de Mensagem:
```c
typedef struct {
    int tipo_mensagem;     // 1: ordem, 2: atualiza√ß√£o, 3: arbitragem, 4: controle
    int origem_id;         // ID do processo origem
    int destino_id;        // ID do processo destino
    int dados_ordem;       // Dados da ordem (simplificado)
    double valor;          // Valor da opera√ß√£o
    char dados_extras[100]; // Dados adicionais
    time_t timestamp;      // Timestamp da mensagem
} MensagemPipe;
```

#### Fun√ß√µes de Envio/Recebimento:
- `enviar_mensagem_pipe()`: Envia mensagem via pipe
- `receber_mensagem_pipe()`: Recebe mensagem via pipe
- Tratamento de erros para pipes cheios/vazios
- Modo n√£o-bloqueante

### 5. **Cria√ß√£o de Mensagens Espec√≠ficas**

#### `criar_mensagem_ordem()`
- **Descri√ß√£o**: Cria mensagem de ordem de compra/venda
- **Par√¢metros**: trader_id, acao_id, tipo, preco, quantidade

#### `criar_mensagem_atualizacao_preco()`
- **Descri√ß√£o**: Cria mensagem de atualiza√ß√£o de pre√ßo
- **Par√¢metros**: acao_id, preco_anterior, preco_novo

#### `criar_mensagem_arbitragem()`
- **Descri√ß√£o**: Cria mensagem de detec√ß√£o de arbitragem
- **Par√¢metros**: acao1_id, acao2_id, diferenca, percentual

#### `criar_mensagem_controle()`
- **Descri√ß√£o**: Cria mensagem de controle do sistema
- **Par√¢metros**: comando, origem_id, destino_id

### 6. **Integra√ß√£o com Processos**

#### Atualiza√ß√£o de `main_processos.c`:
- Cria√ß√£o de pipes antes do `fork()`
- Fechamento de descritores desnecess√°rios em cada processo filho
- Integra√ß√£o com mem√≥ria compartilhada
- Limpeza de pipes ao parar processos

**Exemplo de uso em processos:**
```c
// Processo pai cria pipes
int* descritores = criar_pipes_sistema();

// Processo filho fecha descritores desnecess√°rios
close(descritores[0]); // Traders->Executor RD
close(descritores[1]); // Traders->Executor WR
// ... outros descritores

// Envio de mensagem
MensagemPipe ordem = criar_mensagem_ordem(0, 1, 'C', 25.50, 100);
enviar_mensagem_pipe(descritores[1], &ordem);
```

## üß™ Testes Implementados

### 1. **Teste de Cria√ß√£o de Pipes**
- Verifica√ß√£o de cria√ß√£o bem-sucedida
- Exibi√ß√£o de descritores
- Status dos pipes

### 2. **Teste de Envio e Recebimento**
- Envio de mensagens de teste
- Recebimento e verifica√ß√£o
- Diferentes tipos de mensagem

### 3. **Teste de Comunica√ß√£o Simulada**
- Simula√ß√£o do fluxo completo
- Traders ‚Üí Executor ‚Üí Price Updater ‚Üí Arbitrage Monitor
- Feedback para traders

### 4. **Teste de Tratamento de Erros**
- Envio para pipe inv√°lido
- Recebimento de pipe vazio
- Verifica√ß√£o de comportamentos esperados

### 5. **Teste de M√∫ltiplas Mensagens**
- Envio de m√∫ltiplas mensagens
- Recebimento em sequ√™ncia
- Verifica√ß√£o de integridade

### 6. **Teste de Cria√ß√£o e Fechamento** (TAREFA DO ALUNO)
- Segunda cria√ß√£o de pipes
- Fechamento correto
- Verifica√ß√£o de status ap√≥s fechamento

### 7. **Teste Autom√°tico**
- Fun√ß√£o `testar_pipes_sistema()`
- Teste completo de todas as funcionalidades
- Limpeza autom√°tica

## ‚úÖ Tarefas do Aluno Implementadas

### 1. **Implementa√ß√£o de `criar_pipes_sistema()`**

**Funcionalidades completas:**
- Cria√ß√£o de 5 pipes an√¥nimos
- Array de retorno com 10 descritores
- Configura√ß√£o n√£o-bloqueante
- Log detalhado de cria√ß√£o
- Tratamento de erros robusto

**C√≥digo implementado:**
```c
int* criar_pipes_sistema() {
    printf("=== CRIANDO PIPES DO SISTEMA ===\n");
    
    // Inicializar estrutura
    memset(&sistema_pipes, 0, sizeof(SistemaPipes));
    
    // Array para retornar descritores
    static int descritores[10]; // 5 pipes * 2 descritores cada
    int indice = 0;
    
    // Criar cada pipe com tratamento de erro
    if (pipe(sistema_pipes.traders_to_executor) == -1) {
        perror("ERRO: Falha ao criar pipe Traders -> Executor");
        return NULL;
    }
    // ... continua para todos os pipes
    
    return descritores;
}
```

### 2. **Adi√ß√£o de Tratamento de Erro para Falhas na Cria√ß√£o de Pipes**

**Implementado:**
- Verifica√ß√£o de retorno de `pipe()`
- Limpeza autom√°tica em caso de falha
- Mensagens de erro detalhadas
- Rollback de pipes j√° criados

**Exemplo de tratamento:**
```c
if (pipe(sistema_pipes.executor_to_price_updater) == -1) {
    perror("ERRO: Falha ao criar pipe Executor -> Price Updater");
    limpar_pipes_sistema(); // Limpa pipes j√° criados
    return NULL;
}
```

### 3. **Teste de Cria√ß√£o e Fechamento dos Pipes**

**Implementado em `test_pipes.c`:**
- Segunda cria√ß√£o de pipes
- Verifica√ß√£o de sucesso
- Fechamento correto
- Verifica√ß√£o de status ap√≥s fechamento

**C√≥digo de teste:**
```c
printf("Testando cria√ß√£o de pipes...\n");
int* novos_descriptores = criar_pipes_sistema();
if (novos_descriptores) {
    printf("‚úì Segunda cria√ß√£o de pipes bem-sucedida\n");
    imprimir_status_pipes();
    
    printf("Testando fechamento de pipes...\n");
    limpar_pipes_sistema();
    
    if (!pipes_estao_ativos()) {
        printf("‚úì Pipes fechados corretamente\n");
    }
}
```

## üìä Estruturas de Dados

### Estrutura `SistemaPipes`:
```c
typedef struct {
    int traders_to_executor[2];      // Traders -> Executor
    int executor_to_price_updater[2]; // Executor -> Price Updater
    int price_updater_to_arbitrage[2]; // Price Updater -> Arbitrage Monitor
    int arbitrage_to_traders[2];     // Arbitrage Monitor -> Traders (feedback)
    int control_pipe[2];             // Controle geral do sistema
    int num_pipes_criados;
    int pipes_ativos;
} SistemaPipes;
```

### Estrutura `MensagemPipe`:
```c
typedef struct {
    int tipo_mensagem;     // 1: ordem, 2: atualiza√ß√£o, 3: arbitragem, 4: controle
    int origem_id;         // ID do processo origem
    int destino_id;        // ID do processo destino
    int dados_ordem;       // Dados da ordem (simplificado)
    double valor;          // Valor da opera√ß√£o
    char dados_extras[100]; // Dados adicionais
    time_t timestamp;      // Timestamp da mensagem
} MensagemPipe;
```

## üîß Como Usar

### Compila√ß√£o:
```bash
make test-compile
```

### Execu√ß√£o dos Testes:
```bash
make run-test-pipes
```

### Execu√ß√£o Manual:
```bash
./test_pipes
```

## üìà Funcionalidades Avan√ßadas

### 1. **Comunica√ß√£o Bidirecional**
- Fluxo principal: Traders ‚Üí Executor ‚Üí Price Updater ‚Üí Arbitrage Monitor
- Feedback: Arbitrage Monitor ‚Üí Traders
- Controle: Comunica√ß√£o geral do sistema

### 2. **Modo N√£o-Bloqueante**
- Pipes configurados como n√£o-bloqueantes
- Tratamento de pipes cheios/vazios
- Comunica√ß√£o ass√≠ncrona

### 3. **Gerenciamento de Descritores**
- Fechamento autom√°tico de descritores desnecess√°rios
- Limpeza adequada ao finalizar
- Preven√ß√£o de vazamentos de descritores

### 4. **Tratamento de Erros Robusto**
- Verifica√ß√£o de cria√ß√£o de pipes
- Rollback em caso de falha
- Mensagens de erro detalhadas

### 5. **Integra√ß√£o com Processos**
- Cria√ß√£o antes do `fork()`
- Fechamento em processos filhos
- Limpeza ao parar processos

## üéØ Resultados dos Testes

### ‚úÖ **Testes Bem-sucedidos:**
- Cria√ß√£o de pipes do sistema
- Verifica√ß√£o de status dos pipes
- Envio e recebimento de mensagens
- Comunica√ß√£o entre processos simulada
- Tratamento de erros
- M√∫ltiplas mensagens
- Cria√ß√£o e fechamento de pipes
- Teste autom√°tico dos pipes
- Gerenciamento correto de descritores de arquivo

### üìä **M√©tricas Observadas:**
- **5 pipes** criados com sucesso
- **10 descritores** gerenciados corretamente
- **4 tipos de mensagem** implementados
- **Comunica√ß√£o bidirecional** funcional
- **Tratamento de erros** robusto
- **Limpeza adequada** de recursos

## üîç Melhorias Futuras

### 1. **Funcionalidades Adicionais**
- Pipes nomeados para persist√™ncia
- Comunica√ß√£o multicast
- Prioriza√ß√£o de mensagens
- Compress√£o de dados

### 2. **Monitoramento Avan√ßado**
- M√©tricas de throughput
- Lat√™ncia de comunica√ß√£o
- Detec√ß√£o de gargalos
- Logs estruturados

### 3. **Seguran√ßa**
- Valida√ß√£o de mensagens
- Criptografia de dados
- Controle de acesso
- Auditoria de comunica√ß√£o

## üéâ Conclus√£o

O sistema de pipes foi implementado com sucesso, incluindo:

‚úÖ **Cria√ß√£o robusta** de pipes do sistema  
‚úÖ **Tratamento de erros** para falhas na cria√ß√£o  
‚úÖ **Teste completo** de cria√ß√£o e fechamento  
‚úÖ **Gerenciamento correto** de descritores de arquivo  
‚úÖ **Comunica√ß√£o bidirecional** entre processos  
‚úÖ **Integra√ß√£o perfeita** com o sistema de trading  
‚úÖ **Modo n√£o-bloqueante** para comunica√ß√£o ass√≠ncrona  
‚úÖ **Limpeza adequada** de recursos  
‚úÖ **Testes abrangentes** com casos reais  

O sistema demonstra uma arquitetura de comunica√ß√£o robusta e escal√°vel para sistemas distribu√≠dos. 